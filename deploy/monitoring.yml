





---
# Monitoring setup playbook
- name: Setup monitoring stack
  hosts: all-servers
  become: true
  vars_files:
    - "group_vars/all.yml"

  tasks:
    - name: Create monitoring directory
      file:
        path: "{{ project_root }}/monitoring"
        state: directory
        mode: '0755'

    - name: Deploy Prometheus
      docker_container:
        name: prometheus
        image: prom/prometheus:v2.45.0
        state: started
        restart_policy: always
        ports:
          - "9090:9090"
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "{{ project_root }}/observability/prometheus.yml:/etc/prometheus/prometheus.yml"
          - "prometheus_data:/prometheus"

    - name: Deploy Grafana
      docker_container:
        name: grafana
        image: grafana/grafana:9.5.1
        state: started
        restart_policy: always
        ports:
          - "3002:3000"
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "grafana_data:/var/lib/grafana"
          - "{{ project_root }}/observability/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml"
          - "{{ project_root }}/observability/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml"
          - "{{ project_root }}/observability/dashboards:/var/lib/grafana/dashboards"
        env:
          GF_SECURITY_ADMIN_USER: "admin"
          GF_SECURITY_ADMIN_PASSWORD: "admin"

    - name: Deploy Promtail for logs
      docker_container:
        name: promtail
        image: grafana/promtail:2.8.2
        state: started
        restart_policy: always
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "/var/lib/docker/containers:/var/lib/docker/containers:ro"
          - "/var/run/docker.sock:/var/run/docker.sock"
          - "{{ project_root }}/observability/promtail-config.yml:/etc/promtail/config.yml"

    - name: Deploy Loki for log aggregation
      docker_container:
        name: loki
        image: grafana/loki:2.8.2
        state: started
        restart_policy: always
        ports:
          - "3100:3100"
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "loki_data:/loki"

    - name: Report monitoring setup status
      debug:
        msg: "Monitoring stack deployed on {{ inventory_hostname }}"



